<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek NJKB & PKB Sederhana</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Gaya CSS (Biarkan tetap sama) */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
        }
        .main-wrapper {
            width: 95%;
            max-width: 550px;
            margin: 0 auto;
        }
        .container {
            background-color: #fff;
            padding: 2em;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0.5em; 
            margin-bottom: 1.5em;
            font-size: 1.8em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .recap-title-wrapper h3 { 
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 700;
            margin: 0;
            padding: 0 15px;
            display: inline-block;
        }
        .recap-title-wrapper h2 { 
            color: #2c3e50;
            font-size: 1.5em;
            font-weight: 700;
            margin: 0;
            padding: 0 15px;
            display: inline-block;
            border-bottom: none; 
        }
        .recap-title-wrapper {
            text-align: center;
            margin-bottom: 1.5em;
            margin-top: 1em;
        }
        .recap-title-wrapper .title-line {
            display: block;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, #e74c3c, #f39c12); 
            border-radius: 5px;
            margin-top: 5px;
        }
        .form-group {
            margin-bottom: 1.5em;
        }
        label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 700;
            color: #34495e;
        }
        input[type="text"],
        input[type="date"], 
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[readonly] {
            background-color: #ecf0f1;
            cursor: default;
        }
        input:disabled {
            background-color: #ffebe8;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            margin-bottom: 20px;
            flex-direction: row;
        }
        .button-group button {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 700;
            transition: background-color 0.3s;
        }
        
        #showDetailButton, #showRecapButton {
            background-color: #3498db;
            color: white;
        }
        #showDetailButton:hover, #showRecapButton:hover {
            background-color: #2980b9;
        }
        #showDetailButton:disabled, #showRecapButton:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .table-container {
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #fcfcfc;
        }
        .mobile-card-view {
             margin-top: 1.5em;
             margin-bottom: 1.5em;
             padding: 15px;
             border: 1px solid #ddd;
             border-radius: 10px;
             background-color: #fcfcfc;
             display: none; 
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
            margin-top: 10px;
        }
        #rekapTableContainer thead th, #recapModal thead th {
             padding: 0.8em;
             text-align: left;
             background-color: #f4f7f8;
             font-weight: bold;
             font-size: 0.8em;
             color: #333;
             text-transform: uppercase;
        }
        #rekapTableContainer tbody td, #recapModal tbody td {
            padding: 0.8em;
            font-size: 0.85em;
            font-weight: 500;
            border-bottom: 1px solid #eee;
        }
        .col-keterangan { text-align: left !important; font-weight: 700; color: #2c3e50; }
        .col-nilai { text-align: right !important; }
        
        #totalJumlah, #totalJumlahMobile, #totalJumlahModal, #totalJumlahMobileModal {
            color: #e74c3c !important;
            font-size: 1.1em;
            font-weight: 900 !important;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
            .container {
                padding: 1em;
            }
            .table-container {
                display: none;
            }
            .mobile-card-view {
                display: block; 
            }
        }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); padding-top: 60px;
        }
        .modal-content {
            background-color: #ffffff; margin: 5% auto; padding: 25px; border: 1px solid #ccc; width: 90%;
            max-width: 450px; border-radius: 10px; position: relative; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s;
        }
        .close-button {
            color: #555; float: right; font-size: 30px; font-weight: bold; line-height: 1; margin-top: -10px;
        }
        .detail-list { list-style: none; padding: 0; }
        .detail-list li { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 0.95em; }
        .detail-list li strong { color: #2c3e50; }
        .dp-pkb-row { font-weight: 700 !important; color: #c0392b !important; border-top: 1px solid #c0392b !important; }
        .dp-pkb-row span { color: #c0392b !important; }
        .card-row { display: flex; justify-content: space-between; margin-bottom: 0.5em; font-size: 0.9em; padding: 0.3em 0; }
        .card-total { background-color: #fef0f0; border-top: 2px solid #e74c3c; padding: 10px 0; margin-top: 10px; }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <div class="container">
        
        <div class="table-container" id="rekapTableContainer">
            <div class="recap-title-wrapper">
                <h2>Rekapitulasi Pajak Kendaraan</h2>
                <span class="title-line"></span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 50%;">Keterangan</th>
                        <th style="width: 25%;">Pokok</th>
                        <th style="width: 25%;">Sanksi</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="col-keterangan">Pokok PKB</td>
                        <td class="col-nilai" id="pkbPokok">0</td> <td class="col-nilai">-</td>
                    </tr>
                    <tr>
                        <td class="col-keterangan">Sanksi Pokok PKB</td>
                        <td class="col-nilai">-</td>
                        <td class="col-nilai" id="pkbSanksiPokok">0</td> </tr>
                    <tr>
                        <td class="col-keterangan">Opsen PKB</td>
                        <td class="col-nilai" id="pkbOpsen">0</td> <td class="col-nilai">-</td>
                    </tr>
                    <tr>
                        <td class="col-keterangan">Sanksi Opsen PKB</td>
                        <td class="col-nilai">-</td>
                        <td class="col-nilai" id="pkbSanksiOpsen">0</td> </tr>
                    <tr>
                        <td class="col-keterangan">SWDKLLJ</td>
                        <td class="col-nilai" id="swdklljPokok">0</td> <td class="col-nilai">-</td>
                    </tr>
                    <tr>
                        <td class="col-keterangan">Sanksi SWDKLLJ</td>
                        <td class="col-nilai">-</td>
                        <td class="col-nilai" id="swdklljSanksi">0</td> </tr>
                    <tr style="background-color: #f7f7f7;">
                        <td class="col-keterangan">Total Jumlah Pembayaran</td>
                        <td colspan="2" class="col-nilai" id="totalJumlah">0</td> </tr>
                </tbody>
            </table>
        </div>

        <div class="mobile-card-view" id="mobileCardView">
            <div class="recap-title-wrapper">
                <h3>Rekapitulasi Pajak Kendaraan</h3>
                <span class="title-line"></span>
            </div>
            <div class="card-item">
                <div class="card-row">
                    <span class="card-label">Pokok PKB :</span>
                    <span class="card-value" id="pkbPokokMobile">0</span> </div>
                <div class="card-row">
                    <span class="card-label">Sanksi Pokok PKB :</span>
                    <span class="card-value" id="pkbSanksiPokokMobile">0</span> </div>
                <div class="card-row">
                    <span class="card-label">Opsen PKB :</span>
                    <span class="card-value" id="pkbOpsenMobile">0</span> </div>
                <div class="card-row">
                    <span class="card-label">Sanksi Opsen PKB :</span>
                    <span class="card-value" id="pkbSanksiOpsenMobile">0</span> </div>
                <div class="card-row">
                    <span class="card-label">SWDKLLJ :</span>
                    <span class="card-value" id="swdklljPokokMobile">0</span> </div>
                <div class="card-row">
                    <span class="card-label">Sanksi SWDKLLJ :</span>
                    <span class="card-value" id="swdklljSanksiMobile">0</span> </div>
                <div class="card-row card-total">
                    <span class="card-label">Jumlah Pembayaran :</span>
                    <span class="card-value" id="totalJumlahMobile">0</span> </div>
            </div>
        </div>

        <div class="button-group">
            <button id="showRecapButton" disabled><i class="fas fa-calculator"></i> Rekapitulasi</button>
            <button id="showDetailButton" disabled><i class="fas fa-info-circle"></i> Detail Data</button>
        </div>
        
        <div class="form-group">
            <label for="dueDateInput">Tanggal Jatuh Tempo:</label>
            <input type="date" id="dueDateInput" value="2025-01-01">
        </div>
        
        <div class="form-group">
            <label for="categorySelect">Kategori Kendaraan:</label>
            <select id="categorySelect">
                <option value="">-- Pilih Kategori --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="kodingInput">Kode Kendaraan (KODING):</label>
            <input type="text" id="kodingInput" disabled placeholder="Pilih Kategori Kendaraan terlebih dahulu...">
        </div>

        <div class="form-group">
            <label for="vehicleTypeSelect">Merk Tipe Tahun Buat:</label>
            <select id="vehicleTypeSelect">
                <option value="">Masukkan Kode Kendaraan untuk memuat...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="njkbOutput">Nilai Jual Kendaraan Bermotor (NJKB):</label>
            <input type="text" id="njkbOutput" readonly placeholder="NJKB akan tampil di sini...">
        </div>
        
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="modal-body">
            <h3>Detail Data Kendaraan Terpilih</h3>
            <ul id="detailList" class="detail-list">
                </ul>
        </div>
    </div>
</div>

<div id="recapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="closeRecapModal">&times;</span>
        <div class="modal-body">
            <div class="recap-title-wrapper">
                <h3>Rekapitulasi Pajak Kendaraan</h3>
                <span class="title-line"></span>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50%;">Keterangan</th>
                            <th style="width: 25%;">Pokok</th>
                            <th style="width: 25%;">Sanksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="col-keterangan">Pokok PKB</td>
                            <td class="col-nilai" id="pkbPokokModal">0</td> <td class="col-nilai">-</td>
                        </tr>
                        <tr>
                            <td class="col-keterangan">Sanksi Pokok PKB</td>
                            <td class="col-nilai">-</td>
                            <td class="col-nilai" id="pkbSanksiPokokModal">0</td> </tr>
                        <tr>
                            <td class="col-keterangan">Opsen PKB</td>
                            <td class="col-nilai" id="pkbOpsenModal">0</td> <td class="col-nilai">-</td>
                        </tr>
                        <tr>
                            <td class="col-keterangan">Sanksi Opsen PKB</td>
                            <td class="col-nilai">-</td>
                            <td class="col-nilai" id="pkbSanksiOpsenModal">0</td> </tr>
                        <tr>
                            <td class="col-keterangan">SWDKLLJ</td>
                            <td class="col-nilai" id="swdklljPokokModal">0</td> <td class="col-nilai">-</td>
                        </tr>
                        <tr>
                            <td class="col-keterangan">Sanksi SWDKLLJ</td>
                            <td class="col-nilai">-</td>
                            <td class="col-nilai" id="swdklljSanksiModal">0</td> </tr>
                        <tr style="background-color: #f7f7f7;">
                            <td class="col-keterangan">Total Jumlah Pembayaran</td>
                            <td colspan="2" class="col-nilai" id="totalJumlahModal">0</td> </tr>
                    </tbody>
                </table>
            </div>

            <div class="mobile-card-view">
                <div class="card-item">
                    <div class="card-row">
                        <span class="card-label">Pokok PKB (Pokok):</span>
                        <span class="card-value" id="pkbPokokMobileModal">0</span> </div>
                    <div class="card-row">
                        <span class="card-label">Sanksi Pokok PKB (Sanksi):</span>
                        <span class="card-value" id="pkbSanksiPokokMobileModal">0</span> </div>
                    <div class="card-row">
                        <span class="card-label">Opsen PKB (Pokok):</span>
                        <span class="card-value" id="pkbOpsenMobileModal">0</span> </div>
                    <div class="card-row">
                        <span class="card-label">Sanksi Opsen PKB (Sanksi):</span>
                        <span class="card-value" id="pkbSanksiOpsenMobileModal">0</span> </div>
                    <div class="card-row">
                        <span class="card-label">SWDKLLJ (Pokok):</span>
                        <span class="card-value" id="swdklljPokokMobileModal">0</span> </div>
                    <div class="card-row">
                        <span class="card-label">Sanksi SWDKLLJ (Sanksi):</span>
                        <span class="card-value" id="swdklljSanksiMobileModal">0</span> </div>
                    <div class="card-row card-total">
                        <span class="card-label">Total Pembayaran:</span>
                        <span class="card-value" id="totalJumlahMobileModal">0</span> </div>
                </div>
            </div>

        </div>
    </div>
</div>


<script>
    // --- KONFIGURASI KATEGORI ---
    const CATEGORY_CONFIGS = {
        // Hapus properti 'file' karena kita memuat data per KODING
        'motor_r2': { swdkllj: 35000, label: 'Sepeda Motor Roda 2' },
        'mobil_penumpang': { swdkllj: 143000, label: 'Mobil Penumpang' },
        'mobil_barang': { swdkllj: 163000, label: 'Mobil Barang' },
        'mobil_bus': { swdkllj: 153000, label: 'Mobil Bus' },
        'motor_r3': { swdkllj: 35000, label: 'Sepeda Motor Roda 3' },
        'mobil_roda_3': { swdkllj: 100000, label: 'Mobil Roda 3' }
    };

    // --- INISIALISASI ELEMEN & VARIABEL ---
    const categorySelect = document.getElementById('categorySelect');
    const kodingInput = document.getElementById('kodingInput');
    const vehicleTypeSelect = document.getElementById('vehicleTypeSelect');
    const njkbOutput = document.getElementById('njkbOutput');
    const dueDateInput = document.getElementById('dueDateInput'); 

    const showDetailButton = document.getElementById('showDetailButton');
    const showRecapButton = document.getElementById('showRecapButton');

    const detailModal = document.getElementById('detailModal');
    const recapModal = document.getElementById('recapModal'); 
    
    const closeModalBtn = detailModal.querySelector('.close-button');
    const closeRecapModalBtn = document.getElementById('closeRecapModal');

    const detailList = document.getElementById('detailList');

    let selectedVehicleDetail = null;

    // --- KONSTANTA PAJAK (Asumsi untuk contoh perhitungan) ---
    const PKB_RATE = 0.02; 
    const OPSEN_RATE = 0.10; 
    const SANCTION_PKB_POKOK_RATE = 0; 
    const SANCTION_OPSEN_PKB_RATE = 0; 
    const SANCTION_SWDKLLJ_RATE = 0; 

    // --- FUNGSI UTILITAS: RUPIAH ---
    function formatRupiah(number) {
        if (isNaN(number) || number === null) return '0';
        const num = typeof number === 'string' ? parseFloat(number.toString().replace(/[^0-9.]/g, '')) : number;
        return Math.round(num).toLocaleString('id-ID'); 
    }

    function populateCategoryDropdown() {
        for (const key in CATEGORY_CONFIGS) {
            const config = CATEGORY_CONFIGS[key];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = config.label;
            categorySelect.appendChild(option);
        }
    }

    // --- FUNGSI UNTUK MENGHITUNG DAN MEMPERBARUI REKAPITULASI ---
    function updateRecapData(dpPkb, swdkllj) {
        if (dpPkb === 0 || isNaN(dpPkb)) {
            dpPkb = 0;
            swdkllj = 0;
        }

        const pkbPokokValue = dpPkb * PKB_RATE;
        const pkbSanksiPokokValue = pkbPokokValue * SANCTION_PKB_POKOK_RATE; 
        const pkbOpsenValue = pkbPokokValue * OPSEN_RATE; 
        const pkbSanksiOpsenValue = pkbOpsenValue * SANCTION_OPSEN_PKB_RATE; 
        const swdklljPokokValue = swdkllj;
        const swdklljSanksiValue = swdklljPokokValue * SANCTION_SWDKLLJ_RATE;

        const totalPajak = pkbPokokValue + pkbSanksiPokokValue + pkbOpsenValue + pkbSanksiOpsenValue + swdklljPokokValue + swdklljSanksiValue;

        const pkbPokokRupiah = formatRupiah(pkbPokokValue);
        const pkbSanksiPokokRupiah = formatRupiah(pkbSanksiPokokValue);
        const pkbOpsenRupiah = formatRupiah(pkbOpsenValue);
        const pkbSanksiOpsenRupiah = formatRupiah(pkbSanksiOpsenValue);

        const swdklljPokokRupiah = formatRupiah(swdklljPokokValue);
        const swdklljSanksiRupiah = formatRupiah(swdklljSanksiValue);
        const totalRupiah = formatRupiah(totalPajak);

        const updates = [
            { suffix: '', p: pkbPokokRupiah, sp: pkbSanksiPokokRupiah, o: pkbOpsenRupiah, so: pkbSanksiOpsenRupiah, swdkllj: swdklljPokokRupiah, sws: swdklljSanksiRupiah, t: totalRupiah }, 
            { suffix: 'Mobile', p: pkbPokokRupiah, sp: pkbSanksiPokokRupiah, o: pkbOpsenRupiah, so: pkbSanksiOpsenRupiah, swdkllj: swdklljPokokRupiah, sws: swdklljSanksiRupiah, t: totalRupiah }, 
            { suffix: 'Modal', p: pkbPokokRupiah, sp: pkbSanksiPokokRupiah, o: pkbOpsenRupiah, so: pkbSanksiOpsenRupiah, swdkllj: swdklljPokokRupiah, sws: swdklljSanksiRupiah, t: totalRupiah }, 
            { suffix: 'MobileModal', p: pkbPokokRupiah, sp: pkbSanksiPokokRupiah, o: pkbOpsenRupiah, so: pkbSanksiOpsenRupiah, swdkllj: swdklljPokokRupiah, sws: swdklljSanksiRupiah, t: totalRupiah } 
        ];

        updates.forEach(up => {
            document.getElementById(`pkbPokok${up.suffix}`).textContent = up.p;
            document.getElementById(`pkbSanksiPokok${up.suffix}`).textContent = up.sp;
            document.getElementById(`pkbOpsen${up.suffix}`).textContent = up.o;
            document.getElementById(`pkbSanksiOpsen${up.suffix}`).textContent = up.so;
            document.getElementById(`swdklljPokok${up.suffix}`).textContent = up.swdkllj;
            document.getElementById(`swdklljSanksi${up.suffix}`).textContent = up.sws;
            document.getElementById(`totalJumlah${up.suffix}`).textContent = up.t;
        });

        if (selectedVehicleDetail) {
            selectedVehicleDetail.pkbPokokRupiah = pkbPokokRupiah;
            selectedVehicleDetail.pkbSanksiPokokRupiah = pkbSanksiPokokRupiah;
            selectedVehicleDetail.pkbOpsenRupiah = pkbOpsenRupiah;
            selectedVehicleDetail.pkbSanksiOpsenRupiah = pkbSanksiOpsenRupiah;
            selectedVehicleDetail.swdklljPokokRupiah = swdklljPokokRupiah;
            selectedVehicleDetail.swdklljSanksiRupiah = swdklljSanksiRupiah;
        }
    }
    
    // --- FUNGSI UNTUK MENGELOLA PERUBAHAN KATEGORI ---
    function handleCategoryChange() {
        const categoryKey = categorySelect.value;
        const config = CATEGORY_CONFIGS[categoryKey];

        njkbOutput.value = '';
        selectedVehicleDetail = null;
        showDetailButton.disabled = true;
        showRecapButton.disabled = true;
        updateRecapData(0, 0); 
        vehicleTypeSelect.innerHTML = '<option value="">Masukkan Kode Kendaraan untuk memuat...</option>';

        if (config) {
            kodingInput.disabled = false;
            kodingInput.placeholder = "Masukkan KODING untuk memuat data kendaraan...";
            kodingInput.value = ''; 
        } else {
            kodingInput.disabled = true;
            kodingInput.placeholder = "Pilih Kategori Kendaraan terlebih dahulu...";
        }
    }

    // --- FUNGSI PENCARIAN & PEMUATAN DATA BERDASARKAN KODING (ON-DEMAND) ---
    async function searchAndFetchData() {
        const searchKoding = kodingInput.value.trim().toUpperCase();

        vehicleTypeSelect.innerHTML = '<option value="">Memuat data...</option>';
        njkbOutput.value = '';
        showDetailButton.disabled = true;
        showRecapButton.disabled = true;
        selectedVehicleDetail = null;
        updateRecapData(0, 0); 

        // Aturan: Minimal 5 karakter KODING (sesuaikan jika perlu)
        if (searchKoding.length < 5) { 
            vehicleTypeSelect.innerHTML = '<option value="">Masukkan KODING lengkap...</option>';
            return;
        }
        
        // Membangun URL ke file JSON kecil
        const dataUrl = `data/${searchKoding}.json`; 

        try {
            // Fetch hanya file kecil yang spesifik
            const response = await fetch(dataUrl);

            if (!response.ok) {
                // KODING tidak ditemukan (Error 404)
                vehicleTypeSelect.innerHTML = '<option value="">KODING tidak ditemukan (File JSON tidak ada)</option>';
                return;
            }

            const rawData = await response.json();
            // Lewati header array [0]
            let filteredData = rawData.slice(1); 
            
            if (filteredData.length === 0) {
                 vehicleTypeSelect.innerHTML = '<option value="">Data KODING kosong</option>';
                return;
            }

            // --- Pemrosesan dan Pembersihan Data ---
            let lastValidKoding = searchKoding; 
            let lastValidMerk = null;
            let lastValidType = null;
            
            filteredData.forEach((item, index) => {
                const newItem = {
                    TAHUN_BUAT: item['TAHUN\nBUAT'] || item.TAHUN_BUAT, 
                    DP_PKB: item.DP_PKB || item['DP\nPKB'] || 0,
                    NJKB: item.NJKB || 0,
                    BOBOT: item.BOBOT || 0,
                    KODING: item.KODING,
                    MERK: item.MERK,
                    TYPE: item.TYPE,
                };
                
                // Logic pengisian data kosong dari baris sebelumnya (hanya untuk kelompok data kecil ini)
                newItem.KODING = lastValidKoding; // Tetapkan berdasarkan KODING yang dicari

                if (newItem.MERK && newItem.MERK.toString().trim() !== '') {
                    lastValidMerk = newItem.MERK.trim();
                }
                newItem.MERK = lastValidMerk;

                if (newItem.TYPE && newItem.TYPE.toString().trim() !== '') {
                    lastValidType = newItem.TYPE.trim();
                }
                newItem.TYPE = lastValidType;

                // Membersihkan data header
                if (typeof newItem.NJKB === 'string' && newItem.NJKB.toUpperCase().includes('NJKB')) { newItem.NJKB = 0; }
                if (typeof newItem.DP_PKB === 'string' && newItem.DP_PKB.toUpperCase().includes('DP')) { newItem.DP_PKB = 0; }
                if (typeof newItem.TAHUN_BUAT === 'string' && newItem.TAHUN_BUAT.toUpperCase().includes('TAHUN')) { newItem.TAHUN_BUAT = ''; }

                filteredData[index] = newItem; 
            });
            // --- Akhir Pemrosesan Data ---


            // Sorting
            filteredData.sort((a, b) => {
                return (parseInt(String(b.TAHUN_BUAT).replace(/\D/g, '')) || 0) - (parseInt(String(a.TAHUN_BUAT).replace(/\D/g, '')) || 0);
            });

            // Populating Dropdown
            vehicleTypeSelect.innerHTML = '<option value="">Pilih Tipe dan Tahun Buat</option>';
            filteredData.forEach((item, index) => {
                const tahun = item.TAHUN_BUAT || 'N/A';
                const type = item.TYPE || 'Tipe Tidak Diketahui';
                const njkb = item.NJKB || 0;
                const merk = item.MERK || 'Merk N/A';
                const koding = item.KODING || 'N/A';
                const dp_pkb = item.DP_PKB || 0;
                const bobot = item.BOBOT || 0;

                const option = document.createElement('option');
                option.value = `${index}|${koding}|${merk}|${type}|${tahun}|${njkb}|${dp_pkb}|${bobot}`; 
                option.textContent = `${merk} ${type} ${tahun}`;

                vehicleTypeSelect.appendChild(option);
            });

        } catch (error) {
            console.error("Gagal memuat atau memproses data KODING:", error);
            vehicleTypeSelect.innerHTML = '<option value="">Gagal memuat data. Cek console log.</option>';
        }
    }

    // --- FUNGSI UPDATE OUTPUT & SIMPAN DETAIL ---
    function updateOutput() {
        const selectedValue = vehicleTypeSelect.value;
        showDetailButton.disabled = true;
        showRecapButton.disabled = true;
        selectedVehicleDetail = null;
        njkbOutput.value = '';
        updateRecapData(0, 0); 

        if (!selectedValue || selectedValue === '' || selectedValue.includes('KODING tidak ditemukan')) {
            return;
        }

        const categoryKey = categorySelect.value;
        const config = CATEGORY_CONFIGS[categoryKey];
        const swdklljValue = config ? config.swdkllj : 0;

        const [filteredIndex, koding, merk, type, TAHUN_BUAT, njkb, DP_PKB, bobot] = selectedValue.split('|');

        const njkbRupiah = formatRupiah(njkb);
        const dpPkbRupiah = formatRupiah(DP_PKB); 
        const dueDate = dueDateInput.value; 

        njkbOutput.value = njkbRupiah;

        selectedVehicleDetail = {
            koding,
            merk,
            type,
            tahun: TAHUN_BUAT, 
            njkb: njkbRupiah,
            dp_pkb: dpPkbRupiah,
            dp_pkb_raw: parseFloat(DP_PKB), 
            swdkllj_raw: swdklljValue,
            bobot,
            dueDate,
            pkbPokokRupiah: '0', 
            pkbSanksiPokokRupiah: '0', 
            pkbOpsenRupiah: '0', 
            pkbSanksiOpsenRupiah: '0', 
            swdklljPokokRupiah: formatRupiah(swdklljValue), 
            swdklljSanksiRupiah: formatRupiah(0) 
        };

        updateRecapData(selectedVehicleDetail.dp_pkb_raw, selectedVehicleDetail.swdkllj_raw);

        showDetailButton.disabled = false;
        showRecapButton.disabled = false;
    }


    // --- FUNGSI MODAL DETAIL ---
    function showDetailModal() {
        if (!selectedVehicleDetail) return;

        const detail = selectedVehicleDetail;
        const currentCategoryLabel = CATEGORY_CONFIGS[categorySelect.value].label;
        let formattedDueDate = detail.dueDate || 'Tanggal Tidak Ditetapkan';
        const swdklljRupiah = formatRupiah(detail.swdkllj_raw); 

        detailList.innerHTML = `
            <li><strong>Tanggal Jatuh Tempo:</strong> <span>${formattedDueDate}</span></li>
            <li><strong>Kategori Kendaraan:</strong> <span>${currentCategoryLabel}</span></li>
            <li><strong>KODING:</strong> <span>${detail.koding}</span></li>
            <li><strong>Merk Kendaraan:</strong> <span>${detail.merk}</span></li>
            <li><strong>Tipe Kendaraan:</strong> <span>${detail.type}</span></li>
            <li><strong>Tahun Buat:</strong> <span>${detail.tahun || 'N/A'}</span></li>
            <li><strong>NJKB:</strong> <span>${detail.njkb}</span></li>
            <li><strong>Bobot:</strong> <span>${detail.bobot || 'N/A'}</span></li>
            <li class="dp-pkb-row"><strong>DP PKB:</strong> <span>${detail.dp_pkb}</span></li>
            <li><strong>SWDKLLJ:</strong> <span>${swdklljRupiah}</span></li>
        `;

        detailModal.style.display = "block";
    }
    
    // --- FUNGSI MODAL REKAPITULASI ---
    function showRecapModal() {
        if (!selectedVehicleDetail) return;
        recapModal.style.display = "block";
    }

    // --- EVENT LISTENERS & INISIALISASI ---
    populateCategoryDropdown();
    categorySelect.addEventListener('change', handleCategoryChange);
    
    // KRITIS: Mengganti 'input' (setiap ketikan) menjadi 'change' (setelah input selesai)
    // atau 'keyup'/'input' dengan debounce untuk responsif
    kodingInput.addEventListener('change', searchAndFetchData); 
    
    vehicleTypeSelect.addEventListener('change', updateOutput);
    dueDateInput.addEventListener('change', updateOutput); 

    showDetailButton.addEventListener('click', showDetailModal);
    showRecapButton.addEventListener('click', showRecapModal);

    closeModalBtn.addEventListener('click', () => { detailModal.style.display = "none"; });
    closeRecapModalBtn.addEventListener('click', () => { recapModal.style.display = "none"; });

    window.addEventListener('click', (event) => {
        if (event.target == detailModal) { detailModal.style.display = "none"; }
        if (event.target == recapModal) { recapModal.style.display = "none"; }
    });

    handleCategoryChange();
    document.addEventListener('DOMContentLoaded', () => { updateRecapData(0, 0); });
</script>
</body>
</html>
